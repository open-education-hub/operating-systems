<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Lab/Compute/arena">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Arena | Operating Systems</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="http://localhost//operating-systems/Lab/Compute/arena"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Arena | Operating Systems"><meta data-rh="true" name="description" content="Threads and Processes: clone"><meta data-rh="true" property="og:description" content="Threads and Processes: clone"><link data-rh="true" rel="canonical" href="http://localhost//operating-systems/Lab/Compute/arena"><link data-rh="true" rel="alternate" href="http://localhost//operating-systems/Lab/Compute/arena" hreflang="en"><link data-rh="true" rel="alternate" href="http://localhost//operating-systems/Lab/Compute/arena" hreflang="x-default"><link rel="stylesheet" href="/operating-systems/assets/css/styles.17f22a47.css">
<link rel="preload" href="/operating-systems/assets/js/runtime~main.656db2a8.js" as="script">
<link rel="preload" href="/operating-systems/assets/js/main.9db158e3.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/operating-systems/"><div class="navbar__logo"><img src="/operating-systems/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/operating-systems/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">OS</b></a><a class="navbar__item navbar__link" href="/operating-systems/Software Stack">Software Stack</a><a class="navbar__item navbar__link" href="/operating-systems/Lecture">Lecture</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/operating-systems/Lab">Lab</a><a class="navbar__item navbar__link" href="/operating-systems/Assignments">Assignments</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operating-systems/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/Software Stack/">Software Stack</a><button aria-label="Toggle the collapsible sidebar category &#x27;Software Stack&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/Lecture/">Lecture</a><button aria-label="Toggle the collapsible sidebar category &#x27;Lecture&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/operating-systems/Lab/">Lab</a><button aria-label="Toggle the collapsible sidebar category &#x27;Lab&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Lab/lab-setup">Setting up the Lab Environment</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/operating-systems/Lab/Data/">Data</a><button aria-label="Toggle the collapsible sidebar category &#x27;Data&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/operating-systems/Lab/Compute/">Compute</a><button aria-label="Toggle the collapsible sidebar category &#x27;Compute&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Lab/Compute/overview">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Lab/Compute/hardware-perspective">Hardware Perspective</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Lab/Compute/processes">Processes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Lab/Compute/threads">Threads</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Lab/Compute/processes-threads-apache2">Processes-threads-apache2</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Lab/Compute/copy-on-write">Copy-on-Write</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Lab/Compute/synchronization">Synchronization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Lab/Compute/user-level-threads">User-Level Threads</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/operating-systems/Lab/Compute/arena">Arena</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/operating-systems/Lab/IO/">IO</a><button aria-label="Toggle the collapsible sidebar category &#x27;IO&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/operating-systems/Lab/Application Interaction/">Application Interaction</a><button aria-label="Toggle the collapsible sidebar category &#x27;Application Interaction&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/Assignments/">Assignments</a><button aria-label="Toggle the collapsible sidebar category &#x27;Assignments&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/operating-systems/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/operating-systems/Lab/"><span itemprop="name">Lab</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/operating-systems/Lab/Compute/"><span itemprop="name">Compute</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Arena</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Arena</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="threads-and-processes-clone">Threads and Processes: <code>clone</code><a class="hash-link" href="#threads-and-processes-clone" title="Direct link to heading">​</a></h2><p>Let&#x27;s go back to our initial demos that used threads and processes.
We&#x27;ll see that in order to create both threads and processes, the underlying Linux syscall is <code>clone</code>.
For this, we&#x27;ll run both <code>sum_array_threads</code> and <code>sum_array_processes</code> under <code>strace</code>.
As we&#x27;ve already established, we&#x27;re only interested in the <code>clone</code> syscall:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../lab/support/sum-array/c$ strace -e clone ./sum_array_threads 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clone(child_stack=0x7f60b56482b0, flags=CLONE_VM|CLONE_FS|CLONE_FILES|CLONE_SIGHAND|CLONE_THREAD|CLONE_SYSVSEM|CLONE_SETTLS|CLONE_PARENT_SETTID|CLONE_CHILD_CLEARTID, parent_tid=[1819693], tls=0x7f60b5649640, child_tidptr=0x7f60b5649910) = 1819693</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clone(child_stack=0x7f60b4e472b0, flags=CLONE_VM|CLONE_FS|CLONE_FILES|CLONE_SIGHAND|CLONE_THREAD|CLONE_SYSVSEM|CLONE_SETTLS|CLONE_PARENT_SETTID|CLONE_CHILD_CLEARTID, parent_tid=[1819694], tls=0x7f60b4e48640, child_tidptr=0x7f60b4e48910) = 1819694</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../lab/support/sum-array/c$ strace -e clone ./sum_array_processes 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clone(child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD, child_tidptr=0x7f7a4e346650) = 1820599</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clone(child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD, child_tidptr=0x7f7a4e346650) = 1820600</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We ran each program with an argument of 2, so we have 2 calls to <code>clone</code>.
Notice that in the case of threads, the <code>clone</code> syscall receives more arguments.
The relevant flags passed as arguments when creating threads are documented in <a href="https://man.archlinux.org/man/clone3.2.en" target="_blank" rel="noopener noreferrer"><code>clone</code>&#x27;s man page</a>:</p><ul><li><code>CLONE_VM</code>: the child and the parent process share the same VAS</li><li><code>CLONE_{FS,FILES,SIGHAND}</code>: the new thread shares the filesystem information, file and signal handlers with the one that created it
The syscall also receives valid pointers to the new thread&#x27;s stack and TLS, i.e. the only parts of the VAS that are distinct between threads (although they are technically accessible from all threads).</li></ul><p>By contrast, when creating a new process, the arguments of the <code>clone</code> syscall are simpler (i.e. fewer flags are present).
Remember that in both cases <code>clone</code> creates a new <strong>thread</strong>.
When creating a process, <code>clone</code> creates this new thread within a new separate address space.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="libraries-for-parallel-processing">Libraries for Parallel Processing<a class="hash-link" href="#libraries-for-parallel-processing" title="Direct link to heading">​</a></h2><p>In <code>support/sum-array/c/sum_array_threads.c</code> we spawned threads &quot;manually&quot; by using the <code>pthread_create()</code> function.
This is <strong>not</strong> a syscall, but a wrapper over the common syscall used by both <code>fork()</code> (which is also not a syscall) and <code>pthread_create()</code>.</p><p>Still, <code>pthread_create()</code> is not yet a syscall.
In order to see what syscall <code>pthread_create()</code> uses, check out <a href="#threads-and-processes-clone">this section at the end of the lab</a>.</p><p>Most programming languages provide a more advanced API for handling parallel computation.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="stdparallelism-in-d"><code>std.parallelism</code> in D<a class="hash-link" href="#stdparallelism-in-d" title="Direct link to heading">​</a></h3><p>D language&#x27;s standard library exposes the <a href="https://dlang.org/phobos/std_parallelism.html" target="_blank" rel="noopener noreferrer"><code>std.parallelism</code></a>, which provides a series of parallel processing functions.
One such function is <code>reduce()</code>, which splits an array between a given number of threads and applies a given operation to these chunks.
In our case, the operation simply adds the elements to an accumulator: <code>a + b</code>.
Follow and run the code in <code>support/sum-array/d/sum_array_threads_reduce.d</code>.</p><p>The number of threads is used within a <a href="https://dlang.org/phobos/std_parallelism.html#.TaskPool" target="_blank" rel="noopener noreferrer"><code>TaskPool</code></a>.
This structure is a thread manager (not scheduler).
It silently creates the number of threads we request and then <code>reduce()</code> spreads its workload between these threads.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="openmp-for-c">OpenMP for C<a class="hash-link" href="#openmp-for-c" title="Direct link to heading">​</a></h3><p>Unlike D, C does not support parallel computation by design.
It needs a library to do advanced things, like <code>reduce()</code> from D.
We have chosen to use the OpenMP library for this.
Follow the code in <code>support/sum-array/c/sum_array_threads_openmp.c</code>.</p><p>The <code>#pragma</code> used in the code instructs the compiler to enable the <code>omp</code> module, and to parallelise the code.
In this case, we instruct the compiler to perform a reduce of the array, using the <code>+</code> operator, and to store the results in the <code>result</code> variable.
This reduction uses threads to calculate the sum, similar to <code>summ_array_threads.c</code>, but in a much more optimised form.</p><p>Now compile and run the <code>sum_array_threads_openmp</code> binary using 1, 2, 4, and 8 threads as before.
You&#x27;ll see lower running times than <code>sum_array_threads</code> due to the highly-optimised code emitted by the compiler.
For this reason and because library functions are usually much better tested than your own code, it is always preferred to use a library function for a given task.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="shared-memory">Shared Memory<a class="hash-link" href="#shared-memory" title="Direct link to heading">​</a></h2><p>As you remember from the <a href="/data/">Data chapter</a>, one way to allocate a given number of pages is to use the <code>mmap()</code> syscall.
Let&#x27;s look at its <a href="https://man7.org/linux/man-pages/man2/mmap.2.html" target="_blank" rel="noopener noreferrer">man page</a>, specifically at the <code>flags</code> argument.
Its main purpose is to determine the way in which child processes interact with the mapped pages.</p><p><a href="/operating-systems/Lab/Compute/quiz/mmap-cow-flag">Quiz</a></p><p>Now let&#x27;s test this flag, as well as its opposite: <code>MAP_SHARED</code>.
Compile and run the code in <code>support/shared-memory/shared_memory.c</code>.</p><ol><li><p>See the value read by the parent is different from that written by the child.
Modify the <code>flags</code> parameter of <code>mmap()</code> so they are the same.</p></li><li><p>Create a semaphore in the shared page and use it to make the parent signal the child before it can exit.
Use the API defined in <a href="https://man7.org/linux/man-pages/man0/semaphore.h.0p.html" target="_blank" rel="noopener noreferrer"><code>semaphore.h</code></a>.
<strong>Be careful!</strong>
The value written and read previously by the child and the parent, respectively, must not change.</p></li></ol><p>One way of creating a shared semaphore is to place it within a shared memory area, as we&#x27;ve just done.
This only works between &quot;related&quot; processes.
If you want to share a semaphore or other types of memory between any two processes, you need filesystem support.
For this, you should use <strong>named semaphores</strong>, created using <a href="https://man7.org/linux/man-pages/man3/sem_open.3.html" target="_blank" rel="noopener noreferrer"><code>sem_open()</code></a>.
You&#x27;ll get more accustomed to such functions in the <a href="/app-interact/">Application Interaction chapter</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="mini-shell">Mini-shell<a class="hash-link" href="#mini-shell" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="first-step-system-dissected">First Step: <code>system</code> Dissected<a class="hash-link" href="#first-step-system-dissected" title="Direct link to heading">​</a></h3><p>You already know that <code>system</code> calls <code>fork()</code> and <code>execve()</code> to create the new process.
Let&#x27;s see how and why.
First, we run the following command to trace the <code>execve()</code> syscalls used by <code>sleepy_creator</code>.
We&#x27;ll leave <code>fork()</code> for later.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/sleepy$ strace -e execve -ff -o syscalls ./sleepy_creator</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>At this point, you will get two files whose names start with <code>syscalls</code>, followed by some numbers.
Those numbers are the PIDs of the parent and the child process.
Therefore, the file with the higher number contains logs of the <code>execve</code> and <code>clone</code> syscalls issued by the parent process, while
the other logs those two syscalls when made by the child process.
Let&#x27;s take a look at them.
The numbers below will differ from those on your system:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/sleepy:$ cat syscalls.2523393  # syscalls from parent process</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">execve(&quot;sleepy_creator&quot;, [&quot;sleepy_creator&quot;], 0x7ffd2c157758 /* 39 vars */) = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--- SIGCHLD {si_signo=SIGCHLD, si_code=CLD_EXITED, si_pid=2523394, si_uid=1052093, si_status=0, si_utime=0, si_stime=0} ---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+++ exited with 0 +++</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/sleepy:$ cat syscalls.2523394  # syscalls from child process</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">execve(&quot;/bin/sh&quot;, [&quot;sh&quot;, &quot;-c&quot;, &quot;sleep 10&quot;], 0x7ffd36253be8 /* 39 vars */) = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">execve(&quot;/usr/bin/sleep&quot;, [&quot;sleep&quot;, &quot;10&quot;], 0x560f41659d40 /* 38 vars */) = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+++ exited with 0 +++</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><a href="/operating-systems/Lab/Compute/quiz/who-calls-execve-parent">Quiz</a></p><p>Now notice that the child process doesn&#x27;t simply call <code>execve(&quot;/usr/bin/sleep&quot; ...)</code>.
It first changes its virtual address space (VAS) to that of a <code>bash</code> process (<code>execve(&quot;/bin/sh&quot; ...)</code>) and then that <code>bash</code> process switches its VAS to <code>sleep</code>.
Therefore, calling <code>system(&lt;some_command&gt;)</code> is equivalent to running <code>&lt;some_command&gt;</code> in the command-line.</p><p>With this knowledge in mind, let&#x27;s implement our own mini-shell.
Start from the skeleton code in <code>support/mini-shell/mini_shell.c</code>.
We&#x27;re already running our Bash interpreter from the command-line, so there&#x27;s no need to <code>exec</code> another Bash from it.
Simply <code>exec</code> the command.</p><p><a href="/operating-systems/Lab/Compute/quiz/mini-shell-stops-after-command">Quiz</a></p><p>So we need a way to &quot;save&quot; the <code>mini_shell</code> process before <code>exec()</code>-ing our command.
Find a way to do this.</p><blockquote><p><strong>Hint</strong>:  You can see what <code>sleepy</code> does and draw inspiration from there.
Use <code>strace</code> to also list the calls to <code>clone()</code> performed by <code>sleepy</code> or its children.
<a href="#threads-and-processes-clone">Remember</a> what <code>clone()</code> is used for and use its parameters to deduce which of the two scenarios happens to <code>sleepy</code>.</p></blockquote><p><strong>Moral of the story</strong>: We can add another step to the moral of <a href="/operating-systems/Lab/Compute/processes#practice-fork">our previous story</a>.
When spawning a new command, the call order is:</p><ul><li>parent: <code>fork()</code>, <code>exec()</code>, <code>wait()</code></li><li>child: <code>exit()</code></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="command-executor-in-another-language">Command Executor in Another language<a class="hash-link" href="#command-executor-in-another-language" title="Direct link to heading">​</a></h3><p>Now implement the same functionality (a Bash command executor) in any other language, other than C/C++.
Use whatever API is provided by your language of choice for creating and waiting for processes.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-gil">The GIL<a class="hash-link" href="#the-gil" title="Direct link to heading">​</a></h2><p>Throughout this lab, you might have noticed that there were no thread exercises <em>in Python</em>.
If you did, you probably wondered why.
It&#x27;s not because Python does not support threads, because it does, but because of a mechanism called the <strong>Global Interpreter Lock</strong>, or GIL.
As its name suggests, this is a lock implemented inside most commonly used Python interpreter (CPython), which only allows <strong>one</strong> thread to run at a given time.
As a consequence, multithreaded programs written in Python run <strong>concurrently</strong>, not in parallel.
For this reason, you will see no speedup even when you run an embarrassingly parallel code in parallel.</p><p>However, keep in mind that this drawback does not make threads useless in Python.
They are still useful and widely used when a process needs to perform many IO-bound tasks (i.e.: tasks that involve many file reads / writes or network requests).
Such tasks run many blocking syscalls that require the thread to switch from the RUNNING state to WAITING.
Doing so voluntarily makes threads viable because they rarely run for their entire time slice and spend most of the time waiting for data.
So it doesn&#x27;t hurt them to run concurrently, instead of in parallel.</p><p>Do not make the confusion to believe threads in Python are <a href="/operating-systems/Lab/Compute/scheduling.md#user-level-vs-kernel-level-threads">user-level threads</a>.
<a href="https://docs.python.org/3/library/threading.html#threading.Thread" target="_blank" rel="noopener noreferrer"><code>threading.Thread</code></a>s are kernel-level threads.
It&#x27;s just that they are forced to run concurrently by the GIL.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="practice-array-sum-in-python">Practice: Array Sum in Python<a class="hash-link" href="#practice-array-sum-in-python" title="Direct link to heading">​</a></h3><p>Let&#x27;s first probe this by implementing two parallel versions of the code in <code>support/sum-array/python/sum_array_sequential.py</code>.
One version should use threads and the other should use processes.
Run each of them using 1, 2, 4, and 8 threads / processes respectively and compare the running times.
Notice that the running times of the multithreaded implementation do not decrease.
This is because the GIL makes it so that those threads that you create essentially run sequentially.</p><p>The GIL also makes it so that individual Python instructions are atomic.
Run the code in <code>support/race-condition/python/race_condition.py</code>.
Every time, <code>var</code> will be 0 because the GIL doesn&#x27;t allow the two threads to run in parallel and reach the critical section at the same time.
This means that the instructions <code>var += 1</code> and <code>var -= 1</code> become atomic.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="but-why">But Why?<a class="hash-link" href="#but-why" title="Direct link to heading">​</a></h3><p>Unlike Bigfoot, or the Loch Ness monster, we have proof that the GIL is real.
At first glance, this seems like a huge disadvantage.
Why force threads to run sequentially?
The answer has to do with memory management.
In the <a href="/data">Data chapter</a>, you learned that one way of managing memory is via <em>garbage collection</em> (GC).
In Python, the GC uses reference counting, i.e. each object also stores the number of live pointers to it (variables that reference it).
You can see that this number needs to be modified atomically by the interpreter to avoid race conditions.
This involves adding locks to <strong>all</strong> Python data structures.
This large number of locks doesn&#x27;t scale for a language as large and open as Python.
In addition, it also introduces the risk of <em>deadlocks</em>.
You can read more on this topic <a href="https://realpython.com/python-gil/" target="_blank" rel="noopener noreferrer">in this article</a> and if you think eliminating the GIL looks like an easy task, which should have been done long ago, check the requirements <a href="https://wiki.python.org/moin/GlobalInterpreterLock" target="_blank" rel="noopener noreferrer">here</a>.
They&#x27;re not trivial to meet.</p><p>Single-threaded-ness is a common trope for interpreted languages to use some sort of GIL.
<a href="https://git.ruby-lang.org/ruby.git" target="_blank" rel="noopener noreferrer">Ruby MRI, the reference Ruby interpreter</a>, uses a similar mechanism, called the <a href="https://ivoanjo.me/blog/2022/07/17/tracing-ruby-global-vm-lock/" target="_blank" rel="noopener noreferrer">Global VM Lock</a>.
JavaScript is even more straightforward: it is single-threaded by design, also for GC-related reasons.
It does, however, support asynchronous actions, but these are executed on the same thread as every other code.
This is implemented by placing each instruction on a <a href="https://medium.com/swlh/what-does-it-mean-by-javascript-is-single-threaded-language-f4130645d8a9" target="_blank" rel="noopener noreferrer">call stack</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="atomic-assembly">Atomic Assembly<a class="hash-link" href="#atomic-assembly" title="Direct link to heading">​</a></h2><p>No, this section is not about nukes, sadly :(.
Instead, we aim to get accustomed to the way in which the x86 ISA provides atomic instructions.</p><p>This mechanism looks very simple.
It is but <strong>one instruction prefix</strong>: <code>lock</code>.
It is not an instruction with its own separate opcode, but a prefix that slightly modifies the opcode of the following instructions to make the CPU execute it atomically (i.e. with exclusive access to the data bus).</p><p><code>lock</code> must only be place before an instruction that executes a <em>read-modify-write</em> action.
For example, we cannot place it before a <code>mov</code> instruction, as the action of a <code>mov</code> is simply <code>read</code> or <code>write</code>.
Instead, we can place it in front of an <code>inc</code> instruction if its operand is memory.</p><p>Look at the code in <code>support/race-condition/asm/race_condition_lock.S</code>.
It&#x27;s an Assembly equivalent of the code you&#x27;ve already seen many times so far (such as <code>support/race-condition/c/race_condition.c</code>).
Assemble and run it a few times.
Notice the different results you get.</p><p>Now add the <code>lock</code> prefix before <code>inc</code> and <code>dec</code>.
Reassemble and rerun the code.
And now we have synchronized the two threads by leveraging CPU support.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="synchronization---thread-safe-data-structure">Synchronization - Thread-Safe Data Structure<a class="hash-link" href="#synchronization---thread-safe-data-structure" title="Direct link to heading">​</a></h2><p>Now it&#x27;s time for a fully practical exercise.
Go to <code>support/CLIST/</code>.
In the file <code>clist.c</code> you&#x27;ll find a simple implementation of an array list.
Although correct, it is not (yet) thread-safe.</p><p>The code in <code>test.c</code> verifies its single-threaded correctness, while the one in <code>test_parallel.c</code> verifies it works properly with multiple threads.
Your task is to synchronize this data structure using whichever primitives you like.
Try to keep the implementation efficient.
Aim to decrease your running times as much as you can.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="minor-and-major-page-faults">Minor and Major Page Faults<a class="hash-link" href="#minor-and-major-page-faults" title="Direct link to heading">​</a></h2><p>The code in <code>support/page-faults/page_faults.c</code> generates some minor and major page faults.
Open 2 terminals: one in which you will run the program, and one which will monitor the page faults of the program.
In the monitoring terminal, run the following command:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">watch -n 1 &#x27;ps -eo min_flt,maj_flt,cmd | grep ./page_faults | head -n 1&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Compile the program and run it in the other terminal.
You must press <code>enter</code> one time, before the program will prompt you to press <code>enter</code> more times.
Watch the first number on the monitoring terminal;
it increases.
Those are the minor page faults.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="minor-page-faults">Minor Page Faults<a class="hash-link" href="#minor-page-faults" title="Direct link to heading">​</a></h3><p>A minor page fault is generated whenever a requested page is present in the physical memory, as a frame, but that frame isn&#x27;t allocated to the process generating the request.
These types of page faults are the most common, and they happen when calling functions from dynamic libraries, allocating heap memory, loading programs, reading files that have been cached, and many more situations.
Now back to the program.</p><p>The monitoring command already starts with some minor page faults, generated when loading the program.</p><p>After pressing <code>enter</code>, the number increases, because a function from a dynamic library (libc) is fetched when the first <code>printf()</code> is executed.
Subsequent calls to functions that are in the same memory page as <code>printf()</code> won&#x27;t generate other page faults.</p><p>After allocating the 100 Bytes, you might not see the number of page faults increase.
This is because the &quot;bookkeeping&quot; data allocated by <code>malloc()</code> was able to fit in an already mapped page.
The second allocation, the 1GB one, will always gnereate one minor page fault - for the bookkeeping data about the allocated memory zone.
Notice that not all the pages for the 1GB are allocated.
They are allocated - and generate page faults - when modified.
By now you should know that this mechanism is called <a href="/operating-systems/Lab/Compute/copy-on-write">copy-on-write</a>.</p><p>Continue with pressing <code>enter</code> and observing the effects util you reach opening <code>file.txt</code>.</p><p>Note that neither opening a file, getting information about it, nor mapping it in memory using <code>mmap()</code>, generate page faults.
Also note the <code>posix_fadvise()</code> call after the one to <code>fstat()</code>.
With this call we force the OS to not cache the file, so we can generate a <strong>major page fault</strong>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="major-page-faults">Major Page Faults<a class="hash-link" href="#major-page-faults" title="Direct link to heading">​</a></h3><p>Major page faults happen when a page is requested, but it isn&#x27;t present in the physical memory.
These types of page faults happen in 2 situations:</p><ul><li>a page that was swapped out (to the disk), due to lack of memory, is now accessed - this case is harder to show</li><li>the OS needs to read a file from the disk, because the file contents aren&#x27;t present in the cache - the case we are showing now</li></ul><p>Press <code>enter</code> to print the file contents.
Note the second number go up in the monitoring terminal.</p><p>Comment the <code>posix_fadvise()</code> call, recompile the program, and run it again.
You won&#x27;t get any major page fault, because the file contents are cached by the OS, to avoid those page faults.
As a rule, the OS will avoid major page faults whenever possible, because they are very costly in terms of running time.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/operating-systems/Lab/Compute/user-level-threads"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">User-Level Threads</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/operating-systems/Lab/IO/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">IO</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#threads-and-processes-clone" class="table-of-contents__link toc-highlight">Threads and Processes: <code>clone</code></a></li><li><a href="#libraries-for-parallel-processing" class="table-of-contents__link toc-highlight">Libraries for Parallel Processing</a><ul><li><a href="#stdparallelism-in-d" class="table-of-contents__link toc-highlight"><code>std.parallelism</code> in D</a></li><li><a href="#openmp-for-c" class="table-of-contents__link toc-highlight">OpenMP for C</a></li></ul></li><li><a href="#shared-memory" class="table-of-contents__link toc-highlight">Shared Memory</a></li><li><a href="#mini-shell" class="table-of-contents__link toc-highlight">Mini-shell</a><ul><li><a href="#first-step-system-dissected" class="table-of-contents__link toc-highlight">First Step: <code>system</code> Dissected</a></li><li><a href="#command-executor-in-another-language" class="table-of-contents__link toc-highlight">Command Executor in Another language</a></li></ul></li><li><a href="#the-gil" class="table-of-contents__link toc-highlight">The GIL</a><ul><li><a href="#practice-array-sum-in-python" class="table-of-contents__link toc-highlight">Practice: Array Sum in Python</a></li><li><a href="#but-why" class="table-of-contents__link toc-highlight">But Why?</a></li></ul></li><li><a href="#atomic-assembly" class="table-of-contents__link toc-highlight">Atomic Assembly</a></li><li><a href="#synchronization---thread-safe-data-structure" class="table-of-contents__link toc-highlight">Synchronization - Thread-Safe Data Structure</a></li><li><a href="#minor-and-major-page-faults" class="table-of-contents__link toc-highlight">Minor and Major Page Faults</a><ul><li><a href="#minor-page-faults" class="table-of-contents__link toc-highlight">Minor Page Faults</a></li><li><a href="#major-page-faults" class="table-of-contents__link toc-highlight">Major Page Faults</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://curs.upb.ro" target="_blank" rel="noopener noreferrer" class="footer__link-item">Main site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://ocw.cs.pub.ro/courses/so" target="_blank" rel="noopener noreferrer" class="footer__link-item">OCW<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/sisteme.de.operare/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 OS Team</div></div></div></footer></div>
<script src="/operating-systems/assets/js/runtime~main.656db2a8.js"></script>
<script src="/operating-systems/assets/js/main.9db158e3.js"></script>
</body>
</html>