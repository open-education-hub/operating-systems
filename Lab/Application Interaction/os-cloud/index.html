<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Lab/Application Interaction/os-cloud">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">OS Cloud | Operating Systems</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="http://localhost//operating-systems/Lab/Application Interaction/os-cloud"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="OS Cloud | Operating Systems"><meta data-rh="true" name="description" content="In this section, we are going to build a &quot;toy cloud&quot; called OS Cloud."><meta data-rh="true" property="og:description" content="In this section, we are going to build a &quot;toy cloud&quot; called OS Cloud."><link data-rh="true" rel="canonical" href="http://localhost//operating-systems/Lab/Application Interaction/os-cloud"><link data-rh="true" rel="alternate" href="http://localhost//operating-systems/Lab/Application Interaction/os-cloud" hreflang="en"><link data-rh="true" rel="alternate" href="http://localhost//operating-systems/Lab/Application Interaction/os-cloud" hreflang="x-default"><link rel="stylesheet" href="/operating-systems/assets/css/styles.17f22a47.css">
<link rel="preload" href="/operating-systems/assets/js/runtime~main.656db2a8.js" as="script">
<link rel="preload" href="/operating-systems/assets/js/main.9db158e3.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/operating-systems/"><div class="navbar__logo"><img src="/operating-systems/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/operating-systems/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">OS</b></a><a class="navbar__item navbar__link" href="/operating-systems/Software Stack">Software Stack</a><a class="navbar__item navbar__link" href="/operating-systems/Lecture">Lecture</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/operating-systems/Lab">Lab</a><a class="navbar__item navbar__link" href="/operating-systems/Assignments">Assignments</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operating-systems/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/Software Stack/">Software Stack</a><button aria-label="Toggle the collapsible sidebar category &#x27;Software Stack&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/Lecture/">Lecture</a><button aria-label="Toggle the collapsible sidebar category &#x27;Lecture&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/operating-systems/Lab/">Lab</a><button aria-label="Toggle the collapsible sidebar category &#x27;Lab&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Lab/lab-setup">Setting up the Lab Environment</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/operating-systems/Lab/Data/">Data</a><button aria-label="Toggle the collapsible sidebar category &#x27;Data&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/operating-systems/Lab/Compute/">Compute</a><button aria-label="Toggle the collapsible sidebar category &#x27;Compute&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/operating-systems/Lab/IO/">IO</a><button aria-label="Toggle the collapsible sidebar category &#x27;IO&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/operating-systems/Lab/Application Interaction/">Application Interaction</a><button aria-label="Toggle the collapsible sidebar category &#x27;Application Interaction&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Lab/Application Interaction/overview">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Lab/Application Interaction/time-server">Time Server</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Lab/Application Interaction/password-cracker">Password Cracker</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Lab/Application Interaction/x-window-system">The X Window System</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Lab/Application Interaction/dbus">D-Bus</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/operating-systems/Lab/Application Interaction/os-cloud">OS Cloud</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Lab/Application Interaction/arena">Arena</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/Assignments/">Assignments</a><button aria-label="Toggle the collapsible sidebar category &#x27;Assignments&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/operating-systems/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/operating-systems/Lab/"><span itemprop="name">Lab</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/operating-systems/Lab/Application Interaction/"><span itemprop="name">Application Interaction</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">OS Cloud</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>OS Cloud</h1><p>In this section, we are going to build a &quot;toy cloud&quot; called <code>OS Cloud</code>.
Similar to a real cloud (like <code>aws</code>), <code>OS Cloud</code> will allow us to create and manage virtual machines, through an <code>http</code> API.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="containers-vs-vms">Containers vs VMs<a class="hash-link" href="#containers-vs-vms" title="Direct link to heading">​</a></h2><p>Containers are a lightweight virtualization technology that allows multiple isolated user-space instances to run on a single host operating system.
They are often compared to <a href="https://linux.die.net/man/1/chroot" target="_blank" rel="noopener noreferrer"><code>chroot</code></a> because they both provide isolated environments for running applications.</p><p>Cgroups limit, account for, and isolate the resource usage (CPU, memory, disk I/O, network, etc.) of a collection of processes.
They can be used to enforce resource limits, prioritization, accounting, and control.
Namespaces isolate processes from each other by creating independent views of system resources.
There are different types of namespaces, such as user, PID, network, mount, IPC, and UTS.
You can read more about them <a href="https://www.nginx.com/blog/what-are-namespaces-cgroups-how-do-they-work/" target="_blank" rel="noopener noreferrer">here</a>, <a href="https://www.baeldung.com/linux/cgroups-and-namespaces" target="_blank" rel="noopener noreferrer">here</a> and a particularly good read about namespaces can be found <a href="https://blog.quarkslab.com/digging-into-linux-namespaces-part-1.html" target="_blank" rel="noopener noreferrer">here</a></p><p><a href="/operating-systems/Lab/Application Interaction/quiz/cgroups-vs-namespaces">Quiz</a></p><p>However, containers take this isolation a step further by using kernel features such as namespaces and cgroups to provide a more complete and secure isolation of resources.</p><p>Virtual machines, on the other hand, are a heavier form of virtualization that involves running a complete guest operating system on top of a host operating system using a hypervisor.
This allows multiple guest operating systems to run on a single physical machine, each with its own set of virtualized hardware resources.</p><p><img loading="lazy" alt="VMs vs Containers" src="/operating-systems/assets/images/containers-vs-vms-75f454982e671d86b4d127b6bed5db07.svg" class="img_ev3q"></p><p>One key difference between containers and VMs is the level of abstraction.
Containers virtualize the operating system, allowing multiple containers to share the same kernel while providing the illusion of running on separate machines.
VMs virtualize the hardware, allowing multiple guest operating systems to run on the same physical machine while providing the illusion of running on separate physical hardware.</p><p>Another difference is the resource overhead.
Containers are generally more lightweight than VMs because they share the host kernel and do not require a separate guest operating system to be installed.
This means that containers can start up faster and use less memory than VMs.</p><p><a href="/operating-systems/Lab/Application Interaction/quiz/container-vs-vm">Quiz</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="containers">Containers<a class="hash-link" href="#containers" title="Direct link to heading">​</a></h2><p>Our app will make use of <code>docker</code> containers.
A container is an OS-level virtualization method in which a group of userspace processes are isolated from the rest of the system.</p><p>Take for example a database server.
Instead of running it directly on the host system, we&#x27;ll run it in its own container.
This way, the server process will be isolated from other processes on the system.
It will also have its own filesystem.</p><p>Besides isolation, containers are also useful for portability.
Since a container comes with its own filesystem image, we can pack it together will all the dependencies, so that the app will run correctly no matter what packages are installed on the host system.</p><p>Finally, since our application will consist of more than 1 container, we&#x27;ll also use <code>docker-compose</code>, which is a tool that helps us with running multi-container applications.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a class="hash-link" href="#prerequisites" title="Direct link to heading">​</a></h2><p>Make sure the following packages are installed:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo apt-get -y update; sudo apt-get -y install docker-compose jq</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Also, make sure your user can run docker commands.
If not, maybe you need to add it to the <code>docker</code> group:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo usermod -aG docker student</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then, after relogin:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~$ docker ps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If you are running inside a virtual machine, you need to enable nested virtualization.
Example for vmware:</p><p><img loading="lazy" alt="nested-virt-vmware" src="/operating-systems/assets/images/nested_virt_vmware-1b3a6b314c74c626bc006936abb01bf7.png" width="845" height="699" class="img_ev3q"></p><p>For virtualbox:</p><p><img loading="lazy" alt="nested-virt-vbox" src="/operating-systems/assets/images/nested_virt_vbox-4c9c494a233277658f851662ca2dc082.png" width="819" height="590" class="img_ev3q"></p><p>If the button is greyed out, try from the command line:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~$ VBoxManage  list vms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;USO 2022-2023&quot; {042a5725-bfb7-4a46-9743-1164d3acac23}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~$ VBoxManage modifyvm {042a5725-bfb7-4a46-9743-1164d3acac23} --nested-hw-virt on</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="initial-liftoff">Initial Liftoff<a class="hash-link" href="#initial-liftoff" title="Direct link to heading">​</a></h2><p>First, we need to do some initial setup:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ ./initial_setup.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then go to <code>support/os-cloud</code> and run:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ ./setup_db.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Setting up db</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Starting db server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Waiting for db server to start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Stopping db server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Restarting db server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Waiting for db server to start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Creating tables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Stopping db server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ docker-compose up --build</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now the http API will listen on port <code>localhost:5000</code>. Let&#x27;s try:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ curl localhost:5000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Welcome to OS Cloud!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Let&#x27;s check the running virtual machines:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ curl localhost:5000/vm_list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We got an empty list, since there are no virtual machines yet.
Let&#x27;s create one (the command will take about 1 minute to complete):</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ curl -H &quot;Content-Type: application/json&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -d &#x27;{ &quot;name&quot;: &quot;my_vm&quot;, &quot;image&quot;: &quot;ubuntu_22.04&quot;, &quot;network&quot;: &quot;default&quot;, &quot;mem_size&quot;: &quot;2G&quot;, &quot;disk_size&quot;: &quot;10G&quot;}&#x27; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    localhost:5000/vm_create</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;id&quot;:1,&quot;status&quot;:&quot;ok&quot;}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><a href="/operating-systems/Lab/Application Interaction/quiz/vm-creation">Quiz</a></p><p>Check the virtual machine list again:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ curl localhost:5000/vm_list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[{&quot;id&quot;:1,&quot;name&quot;:&quot;my_vm&quot;}]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can also use the <code>jq</code> tool to pretty print the <code>json</code> outputs:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ curl -s localhost:5000/vm_list | jq .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;id&quot;: 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;name&quot;: &quot;my_vm&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We see our newly created virtual machine.
Let&#x27;s get some information about it:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ curl -s -H &quot;Content-Type: application/json&quot; -d &#x27;{ &quot;id&quot;: 1 }&#x27; localhost:5000/vm_info | jq .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;disk_size&quot;: 10737418240,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;id&quot;: 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;ip&quot;: &quot;192.168.0.2&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;mem_size&quot;: 2147483648,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;name&quot;: &quot;my_vm&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;network&quot;: &quot;default&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;os&quot;: &quot;ubuntu_22.04&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;state&quot;: &quot;RUNNING&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We recognize some parameters that we specified at creation time, like <code>mem_size</code> and <code>disk_size</code>.
Also, the IP address <code>192.168.0.2</code> has been allocated for our machine.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="more-implementation-details">More Implementation Details<a class="hash-link" href="#more-implementation-details" title="Direct link to heading">​</a></h2><p>The application consists of 2 containers:</p><ul><li><p><code>db</code>, which runs a <code>MySQL</code> database</p></li><li><p><code>os-cloud</code>, which runs the web application and the virtual machines</p></li></ul><p>Let&#x27;s check them.
After running <code>docker-compose up</code>, in another terminal run <code>docker-compose ps</code>:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ docker-compose ps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       Name                      Command              State                    Ports</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------------------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">os-cloud_db_1         docker-entrypoint.sh mariadbd   Up      3306/tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">os-cloud_os-cloud_1   python3 -u app.py               Up      0.0.0.0:5000-&gt;5000/tcp,:::5000-&gt;5000/tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now let&#x27;s move inside the <code>os-cloud</code> container:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ docker-compose exec os-cloud bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@89a986d2526e:/app#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Since the virtual machines run inside this container, we should expect to see the one that we created in the previous step.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@89a986d2526e:/app# ps -ef | cat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UID          PID    PPID  C STIME TTY          TIME CMD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root           1       0  0 09:02 ?        00:00:00 /sbin/docker-init -- python3 -u app.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root           7       1  0 09:02 ?        00:00:00 python3 -u app.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root          12       7  6 09:02 ?        00:00:41 qemu-system-x86_64 -enable-kvm -m 2048 -hda /vm-disks/1/disk.qcow2 -net nic,macaddr=52:54:00:12:34:00 -net tap,ifname=tap0,script=no -monitor telnet::10001,server,nowait -serial telnet::10002,server,nowait -nographic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root          27       0  0 09:11 pts/3    00:00:00 bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root          35      27  0 09:13 pts/3    00:00:00 ps -ef</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Indeed, a <code>qemu-system-x86_64</code> process is there.
The vm should be accessible via <code>ssh</code> on the IP <code>192.168.0.2</code> with password <code>123456</code> (if you get <code>connection refused</code> here, you need to wait a bit more for the machine to boot):</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@adf6e0bf4e6e:/app# ssh root@192.168.0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The authenticity of host &#x27;192.168.0.2 (192.168.0.2)&#x27; can&#x27;t be established.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ED25519 key fingerprint is SHA256:3Mfa1fB9y4knUDJWEmEOTz9dWOE7SVhnH/kCBJ15Y0E.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This key is not known by any other names</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Are you sure you want to continue connecting (yes/no/[fingerprint])? yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning: Permanently added &#x27;192.168.0.2&#x27; (ED25519) to the list of known hosts.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@192.168.0.2&#x27;s password:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Welcome to Ubuntu 22.04 LTS (GNU/Linux 5.15.0-40-generic x86_64)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Last login: Thu Nov 17 07:49:55 2022</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@ubuntu:~#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The vm is also accessible on the serial console (notice the <code>-serial telnet::10002,server,nowait</code> argument to qemu).
If we start a telnet connection on port <code>10002</code>, qemu will show us the virtual machine&#x27;s serial console (basically the output that we normally see when running a virtual machine in text mode)</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@adf6e0bf4e6e:/app# telnet localhost 10002</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Trying 127.0.0.1...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connected to localhost.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Escape character is &#x27;^]&#x27;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ubuntu login: root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Password:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Welcome to Ubuntu 22.04 LTS (GNU/Linux 5.15.0-40-generic x86_64)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Last login: Thu Nov 17 07:50:11 UTC 2022 from 192.168.0.1 on pts/0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@ubuntu:~#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To exit the serial console, press <code>CTRL+]</code>, then type <code>quit</code>:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@ubuntu:~#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">telnet&gt; quit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connection closed.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@adf6e0bf4e6e:/app#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="even-more-implementation-details">(Even) More Implementation Details<a class="hash-link" href="#even-more-implementation-details" title="Direct link to heading">​</a></h2><p>The architecture of the system can be summarized in the following diagram:</p><p><img loading="lazy" alt="os-cloud" src="/operating-systems/assets/images/os_cloud-ff20c47681f663aa8430106ab44e0cd5.svg" class="img_ev3q"></p><p>The <code>os-cloud</code> container is the core of the entire system.
It consists of a web application written in python using <code>flask</code>.
This web application exposes a virtual machine <code>API</code> that the user can interact with (like <code>vm_create</code>).</p><p>So, when we&#x27;re calling <code>curl</code> like in the example above:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -H &quot;Content-Type: application/json&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -d &#x27;{ &quot;name&quot;: &quot;my_vm&quot;, &quot;image&quot;: &quot;ubuntu_22.04&quot;, &quot;network&quot;: &quot;default&quot;, &quot;mem_size&quot;: &quot;2G&quot;, &quot;disk_size&quot;: &quot;10G&quot;}&#x27; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    localhost:5000/vm_create</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It will do an <code>HTTP POST</code> request (because of the <code>-d</code> parameter) to <code>/vm_create</code>.
The request will be handled by the <code>api_vm_create</code> function in <code>app.py</code> (because of the <code>@app.route(&quot;/vm_create&quot;, methods=[&quot;POST&quot;])</code> line).</p><p>Inside this function, we also have access to the request payload (the string that comes after <code>-d</code> in our <code>curl</code> call).
More specifically, <code>request.json</code> will parse this payload as a <code>JSON</code> object and hand it back to us as a python dictionary.
In this dictionary we&#x27;ll find the parameters for our request, like <code>name</code>, <code>image</code>, <code>network</code>, and so on.</p><p>The function will then take the actions required to create the virtual machine: create the disk, start qemu, interact with the database, etc.
Finally, whatever is returned by the <code>api_vm_create</code> function will be received by the <code>curl</code> request as the <code>HTTP</code> response.
Here we also return <code>JSON</code> objects, like <code>{&quot;id&quot;:1,&quot;status&quot;:&quot;ok&quot;}</code>.</p><p>There are 3 objects used by the system:</p><ul><li><p><code>vm</code> - the actual virtual machine</p></li><li><p><code>disk</code> - holds information about virtual machine disks</p></li><li><p><code>network</code> - holds information about a network</p></li></ul><p>Each of these objects are stored in a table in the database.</p><p>Let&#x27;s check the database contents (take the password from the <code>setup_db.sh</code> file):</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ docker-compose exec db mysql -u os-cloud -p os-cloud</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Enter password:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MariaDB [os-cloud]&gt; select * from vm;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+-------+---------+------------+------------+-------------------+------------+----------+-------------------+------------------+-------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| id | name  | disk_id | mem_size   | network_id | tap_interface_idx | ip         | qemu_pid | qemu_monitor_port | qemu_serial_port | state |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+-------+---------+------------+------------+-------------------+------------+----------+-------------------+------------------+-------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  1 | my_vm |       1 | 2147483648 |          1 |                 0 | 3232235522 |       18 |             10001 |            10002 |     0 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+-------+---------+------------+------------+-------------------+------------+----------+-------------------+------------------+-------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 row in set (0.001 sec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MariaDB [os-cloud]&gt; select * from disk;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+-------------+---------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| id | size        | template_name |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+-------------+---------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  1 | 10737418240 | ubuntu_22.04  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+-------------+---------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 row in set (0.000 sec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MariaDB [os-cloud]&gt; select * from network;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+---------+----------------------+------------+------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| id | name    | bridge_interface_idx | ip         | mask       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+---------+----------------------+------------+------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  1 | default |                    0 | 3232235520 | 4294901760 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+---------+----------------------+------------+------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 row in set (0.000 sec)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>Note: in real life, DON&#x27;T store passwords in text files inside a repository</code>.</p><p>Some observations:</p><ul><li><p>There is a <code>default</code> network already created.
That is why we specified <code>&quot;network&quot;: &quot;default&quot;</code> in the vm creation parameters, and we see that the vm is assigned to this network (<code>network_id</code> is <code>1</code>).</p></li><li><p>This network&#x27;s ip address is <code>3232235520</code>, which in hex is <code>0xC0A80000</code>, that is, <code>192.168.0.0</code>.
The netmask is <code>0xFFFF0000</code>, or <code>/16</code>.
This explains why our vm received the ip address <code>192.168.0.2</code>.</p></li><li><p>There is a disk with the size of <code>10GB</code>, based on the <code>ubuntu_22.04</code> template, exactly like we requested.
This disk is assigned to our vm (<code>disk_id</code> is <code>1</code>).
The disk file will reside in <code>support/os-cloud/vm-disks/1/disk.qcow2</code>, or <code>/vm-disks/1/disk.qcow2</code> inside the container.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="virtual-machine-creation">Virtual Machine Creation<a class="hash-link" href="#virtual-machine-creation" title="Direct link to heading">​</a></h2><p>Take a look at the <code>vm_create</code> function in <code>support/os-cloud/os-cloud/vm.py</code>.
The steps undertaken are roughly:</p><ol><li><p>some initial allocations: the virtual machine IP address, network interface, qemu ports, etc</p></li><li><p>the virtual machine disk is created, based on the template specified by the user (like <code>ubuntu_22.04</code>)</p></li><li><p>the virtual machine is started with this new disk, in order to do some more customizations (the <code>ubuntu_22_04_vm_prepare</code> function)</p></li><li><p>the virtual machine is restarted again with the final disk in place</p></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="disk-creation">Disk Creation<a class="hash-link" href="#disk-creation" title="Direct link to heading">​</a></h2><p>All the disk templates are in <code>support/os-cloud/disk-templates</code>.
This directory will be mounted in <code>/disk-templates</code> inside the container.</p><p>The first step of disk creation is to create a <code>qcow2</code> disk file based on the template specified by the user (step 2 from the explanation above).</p><p>This is done in the <code>create_disk_from_template</code> function in <code>support/os-cloud/os-cloud/disk.py</code>.
The function will first create a disk object in the database, then it will call 2 shell scripts: <code>create_disk_from_template.sh</code> and <code>setup_root_password.sh</code>.</p><p>The second step is to start the virtual machine with this disk and do some customizations (step 3 from above).</p><p>This is done in the <code>ubuntu_22_04_vm_prepare</code> function in <code>support/os-cloud/os-cloud/vm.py</code>.
The code will connect to the vm&#x27;s qemu serial console using <code>pexpect</code>.
Then it will use a series of <code>expect_exact</code> + <code>sendline</code> pairs to interact with the virtual machine, as if those commands were typed in the command-line.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="practice-create-a-new-disk-by-hand">Practice: Create a New Disk by Hand<a class="hash-link" href="#practice-create-a-new-disk-by-hand" title="Direct link to heading">​</a></h2><p>Let&#x27;s replicate the above-mentioned steps and create a new disk ourselves.</p><p>First, we have to call the 2 scripts from the <code>create_disk_from_template</code> function:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ ./disk-templates/ubuntu_22.04/create_disk_from_template.sh ./disk-templates/ubuntu_22.04/ubuntu_22.04.qcow2 my-disk.qcow2 10737418240</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Image resized.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ ls -lh my-disk.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- 1 student student 619M Nov 20 15:41 my-disk.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ sudo ./disk-templates/ubuntu_22.04/setup_root_password.sh my-disk.qcow2 123456</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now we can start a qemu instance using this disk:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ qemu-system-x86_64 -enable-kvm -m 2G -hda my-disk.qcow2 -nographic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Ubuntu 22.04 LTS ubuntu ttyS0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ubuntu login: root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Password:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@ubuntu:~#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Here we can further run customization commands, like the ones in the <code>ubuntu_22_04_vm_prepare</code> function, or any other things that we want.</p><p>When we&#x27;re done, we run the <code>halt</code> command:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@ubuntu:~# halt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@ubuntu:~#          Stopping Session 1 of User root...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  OK  ] Removed slice Slice /system/modprobe.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  OK  ] Stopped target Graphical Interface.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         Starting System Halt...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[   86.431398] reboot: System halted</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When the <code>System halted</code> message is printed, press <code>CTRL+A X</code> to exit qemu (that is, press <code>CTRL+A</code>, release <code>CTRL</code> and <code>A</code>, press <code>X</code>).</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="practice-implement-vm_stop">Practice: Implement <code>vm_stop</code><a class="hash-link" href="#practice-implement-vm_stop" title="Direct link to heading">​</a></h2><p>The <code>vm_stop</code> command will stop a particular virtual machine, meaning it will stop the qemu process for that vm.
The implementation starts in <code>api_vm_stop</code> in <code>app.py</code>, which is the function that handles the <code>http</code> request for the stop operation.
Here you need to do the following:</p><ul><li><p>extract the virtual machine <code>id</code> from the request</p></li><li><p>use the <code>vm.vm_get</code> function to convert this ID into a <code>VM</code> structure</p></li><li><p>call <code>vm.vm_stop</code> and pass the <code>VM</code> object to it</p></li></ul><p>In <code>vm.vm_stop</code>:</p><ul><li><p>call <code>stop_qemu_for_vm</code></p></li><li><p>change the vm pid in the database to <code>-1</code></p></li><li><p>change the vm state in the database to <code>VM_STATE_STOPPED</code></p></li></ul><p>After modifying the code, you should run <code>docker-compose up --build</code> again.
Also, if your database became inconsistent, you can clean it up by re-running the <code>setup_db.sh</code> script.
Then delete all vm disks with <code>sudo rm -rf vm-disks/*</code>.</p><p>With <code>vm_stop</code> implemented, the system should work like this:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ curl -s localhost:5000/vm_list | jq .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;id&quot;: 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;name&quot;: &quot;my_vm&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ curl -H &quot;Content-Type: application/json&quot; -d &#x27;{ &quot;id&quot;: 1}&#x27; localhost:5000/vm_scurl -s -H &quot;Content-Type: application/json&quot; -d &#x27;{ &quot;id&quot;: 1 }&#x27; localhost:5000/vm_info | jq .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;disk_size&quot;: 10737418240,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;id&quot;: 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;ip&quot;: &quot;192.168.0.2&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;mem_size&quot;: 2147483648,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;name&quot;: &quot;my_vm&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;network&quot;: &quot;default&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;os&quot;: &quot;ubuntu_22.04&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;state&quot;: &quot;RUNNING&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The vm is in the <code>RUNNING</code> state.
Now let&#x27;s stop it:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ curl -H &quot;Content-Type: application/json&quot; -d &#x27;{ &quot;id&quot;: 1}&#x27; localhost:5000/vm_stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;status&quot;:&quot;ok&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ curl -s -H &quot;Content-Type: application/json&quot; -d &#x27;{ &quot;id&quot;: 1 }&#x27; localhost:5000/vm_info | jq .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;disk_size&quot;: 10737418240,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;id&quot;: 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;ip&quot;: &quot;192.168.0.2&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;mem_size&quot;: 2147483648,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;name&quot;: &quot;my_vm&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;network&quot;: &quot;default&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;os&quot;: &quot;ubuntu_22.04&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;state&quot;: &quot;STOPPED&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now the state is <code>STOPPED</code>.
Inside the container, the qemu process should be gone as well:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ docker-compose exec os-cloud bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@b0600eff8903:/app# ps -ef</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UID          PID    PPID  C STIME TTY          TIME CMD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root           1       0  0 10:00 ?        00:00:00 /sbin/docker-init -- python3 -u app.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root           7       1  0 10:00 ?        00:00:00 python3 -u app.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root          33       0  0 10:00 pts/3    00:00:00 bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root          41      33  0 10:00 pts/3    00:00:00 ps -ef</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Finally, the vm can be started again using <code>vm_start</code>:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ curl -H &quot;Content-Type: application/json&quot; -d &#x27;{ &quot;id&quot;: 1}&#x27; localhost:5000/vm_start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;status&quot;:&quot;ok&quot;}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/operating-systems/Lab/Application Interaction/dbus"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">D-Bus</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/operating-systems/Lab/Application Interaction/arena"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Arena</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#containers-vs-vms" class="table-of-contents__link toc-highlight">Containers vs VMs</a></li><li><a href="#containers" class="table-of-contents__link toc-highlight">Containers</a></li><li><a href="#prerequisites" class="table-of-contents__link toc-highlight">Prerequisites</a></li><li><a href="#initial-liftoff" class="table-of-contents__link toc-highlight">Initial Liftoff</a></li><li><a href="#more-implementation-details" class="table-of-contents__link toc-highlight">More Implementation Details</a></li><li><a href="#even-more-implementation-details" class="table-of-contents__link toc-highlight">(Even) More Implementation Details</a></li><li><a href="#virtual-machine-creation" class="table-of-contents__link toc-highlight">Virtual Machine Creation</a></li><li><a href="#disk-creation" class="table-of-contents__link toc-highlight">Disk Creation</a></li><li><a href="#practice-create-a-new-disk-by-hand" class="table-of-contents__link toc-highlight">Practice: Create a New Disk by Hand</a></li><li><a href="#practice-implement-vm_stop" class="table-of-contents__link toc-highlight">Practice: Implement <code>vm_stop</code></a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://curs.upb.ro" target="_blank" rel="noopener noreferrer" class="footer__link-item">Main site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://ocw.cs.pub.ro/courses/so" target="_blank" rel="noopener noreferrer" class="footer__link-item">OCW<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/sisteme.de.operare/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 OS Team</div></div></div></footer></div>
<script src="/operating-systems/assets/js/runtime~main.656db2a8.js"></script>
<script src="/operating-systems/assets/js/main.9db158e3.js"></script>
</body>
</html>