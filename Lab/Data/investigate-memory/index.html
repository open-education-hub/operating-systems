<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Lab/Data/investigate-memory">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Investigate Memory Actions | Operating Systems</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="http://localhost//operating-systems/Lab/Data/investigate-memory"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Investigate Memory Actions | Operating Systems"><meta data-rh="true" name="description" content="Memory actions generally mean:"><meta data-rh="true" property="og:description" content="Memory actions generally mean:"><link data-rh="true" rel="canonical" href="http://localhost//operating-systems/Lab/Data/investigate-memory"><link data-rh="true" rel="alternate" href="http://localhost//operating-systems/Lab/Data/investigate-memory" hreflang="en"><link data-rh="true" rel="alternate" href="http://localhost//operating-systems/Lab/Data/investigate-memory" hreflang="x-default"><link rel="stylesheet" href="/operating-systems/assets/css/styles.49519274.css">
<link rel="preload" href="/operating-systems/assets/js/runtime~main.d7a0bbcc.js" as="script">
<link rel="preload" href="/operating-systems/assets/js/main.0eb9fb00.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/operating-systems/"><div class="navbar__logo"><img src="/operating-systems/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/operating-systems/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">OS</b></a><a class="navbar__item navbar__link" href="/operating-systems/Software Stack">Software Stack</a><a class="navbar__item navbar__link" href="/operating-systems/Lecture">Lecture</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/operating-systems/Lab">Lab</a><a class="navbar__item navbar__link" href="/operating-systems/Assignments">Assignments</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operating-systems/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/Software Stack/">Software Stack</a><button aria-label="Toggle the collapsible sidebar category &#x27;Software Stack&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/Lecture/">Lecture</a><button aria-label="Toggle the collapsible sidebar category &#x27;Lecture&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/operating-systems/Lab/">Lab</a><button aria-label="Toggle the collapsible sidebar category &#x27;Lab&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Lab/lab-setup">Setting up the Lab Environment</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/operating-systems/Lab/Data/">Data</a><button aria-label="Toggle the collapsible sidebar category &#x27;Data&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Lab/Data/overview">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Lab/Data/working-memory">Working with Memory</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Lab/Data/process-memory">Process Memory</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/operating-systems/Lab/Data/investigate-memory">Investigate Memory</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Lab/Data/memory-security">Memory Security</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Lab/Data/arena">Arena</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/operating-systems/Lab/Compute/">Compute</a><button aria-label="Toggle the collapsible sidebar category &#x27;Compute&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/operating-systems/Lab/IO/">IO</a><button aria-label="Toggle the collapsible sidebar category &#x27;IO&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/operating-systems/Lab/Application Interaction/">Application Interaction</a><button aria-label="Toggle the collapsible sidebar category &#x27;Application Interaction&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/Assignments/">Assignments</a><button aria-label="Toggle the collapsible sidebar category &#x27;Assignments&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/operating-systems/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/operating-systems/Lab/"><span itemprop="name">Lab</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/operating-systems/Lab/Data/"><span itemprop="name">Data</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Investigate Memory</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Investigate Memory Actions</h1><p>Memory actions generally mean:</p><ul><li>memory access: read, write or execute</li><li>memory allocation</li><li>memory deallocation</li></ul><p>By far, the most important actions are allocation and deallocation.
Because, if not done right, these can get to memory loss and poor memory use.</p><p>Memory loss generally happens in the form of memory leaks.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="memory-leaks">Memory Leaks<a class="hash-link" href="#memory-leaks" title="Direct link to heading">​</a></h2><p>A memory leak occurs when we lose reference to a memory area.
That is, a pointer used to point to a memory area.
And then it&#x27;s pointing to a new memory area and the old memory area is lost.</p><p>Enter the <code>support/memory-leak/</code> folder.
It stores two files showing memory leaks:</p><ul><li>one in C++: <code>memory_leak.cpp</code></li><li>one in C: <code>memory_leak_malloc</code></li></ul><p>Let&#x27;s build and run the two executables:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../lab/support/memory-leak$ make</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">g++    -c -o memory_leak.o memory_leak.cpp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cc   memory_leak.o  -lstdc++ -o memory_leak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cc    -c -o memory_leak_malloc.o memory_leak_malloc.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cc   memory_leak_malloc.o  -lstdc++ -o memory_leak_malloc</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Running them yields similar output:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../lab/support/memory-leak$ ./memory_leak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Andrei Popescu is 22 years old and likes Linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Ioana David is 23 years old and likes macOS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../lab/support/memory-leak$ ./memory_leak_malloc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Andrei Popescu is 22 years old and likes Linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Ioana David is 23 years old and likes macOS</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We investigate the memory leaks of the two programs by using <a href="https://valgrind.org/" target="_blank" rel="noopener noreferrer">Valgrind</a>:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../lab/support/memory-leak$ valgrind ./memory_leak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22362== Memcheck, a memory error detector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22362== Copyright (C) 2002-2017, and GNU GPL&#x27;d, by Julian Seward et al.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22362== Using Valgrind-3.13.0 and LibVEX; rerun with -h for copyright info</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22362== Command: ./memory_leak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22362==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Andrei Popescu is 22 years old and likes Linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Ioana David is 23 years old and likes macOS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22362==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22362== HEAP SUMMARY:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22362==     in use at exit: 72 bytes in 1 blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22362==   total heap usage: 4 allocs, 3 frees, 73,872 bytes allocated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22362==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22362== LEAK SUMMARY:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22362==    definitely lost: 72 bytes in 1 blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22362==    indirectly lost: 0 bytes in 0 blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22362==      possibly lost: 0 bytes in 0 blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22362==    still reachable: 0 bytes in 0 blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22362==         suppressed: 0 bytes in 0 blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22362== Rerun with --leak-check=full to see details of leaked memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22362==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22362== For counts of detected and suppressed errors, rerun with: -v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22362== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../lab/support/memory-leak$ valgrind ./memory_leak_malloc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22369== Memcheck, a memory error detector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22369== Copyright (C) 2002-2017, and GNU GPL&#x27;d, by Julian Seward et al.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22369== Using Valgrind-3.13.0 and LibVEX; rerun with -h for copyright info</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22369== Command: ./memory_leak_malloc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22369==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Andrei Popescu is 22 years old and likes Linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Ioana David is 23 years old and likes macOS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22369==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22369== HEAP SUMMARY:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22369==     in use at exit: 148 bytes in 1 blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22369==   total heap usage: 3 allocs, 2 frees, 1,320 bytes allocated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22369==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22369== LEAK SUMMARY:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22369==    definitely lost: 148 bytes in 1 blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22369==    indirectly lost: 0 bytes in 0 blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22369==      possibly lost: 0 bytes in 0 blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22369==    still reachable: 0 bytes in 0 blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22369==         suppressed: 0 bytes in 0 blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22369== Rerun with --leak-check=full to see details of leaked memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22369==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22369== For counts of detected and suppressed errors, rerun with: -v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==22369== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As we are doing allocations that are not freed, this results in memory leaks.</p><p>For <code>malloc()</code>-based programs, we can use <a href="https://man7.org/linux/man-pages/man3/mtrace.3.html" target="_blank" rel="noopener noreferrer"><code>mtrace()</code> feature</a> and <a href="https://man7.org/linux/man-pages/man1/mtrace.1.html" target="_blank" rel="noopener noreferrer"><code>mtrace</code> command</a> to verify proper allocations with <code>malloc()</code> and deallocations with <code>free()</code>.
We call <code>mtrace()</code> in the program (in <code>memory_leak_malloc.c</code>) to enable <code>malloc()</code> and <code>free()</code> checking.</p><p>To use <code>mtrace()</code> we define the <code>MALLOC_TRACE</code> environment variable:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../lab/support/memory-leak$ MALLOC_TRACE=mem.trace ./memory_leak_malloc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Andrei Popescu is 22 years old and likes Linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Ioana David is 23 years old and likes macOS</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Subsequently, we use the <code>mtrace</code> tool to show information about the leaked data:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../lab/support/memory-leak$ mtrace ./memory_leak_malloc mem.trace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Memory not freed:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           Address     Size     Caller</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x000056506d8be6a0     0x94  at 0x56506c3777ec</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The size (<code>0x94</code>) is the same value shown by Valgrind (<code>148</code>).</p><p><code>mtrace</code> provides an outcome similar to Valgrind.
Valgrind is however more powerful: it works on different types of memory (not only those allocated with <code>malloc()</code>) and it doesn&#x27;t require access to the source code (and the compiler phase).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="practice">Practice<a class="hash-link" href="#practice" title="Direct link to heading">​</a></h3><ol><li><p>Print the size of the <code>Student</code> class and the <code>struct student</code> structure to see if it equates to the leak shown by Valgrind.</p></li><li><p>Solve the memory leaks in both programs.
Validate with Valgrind.</p></li></ol><p><a href="/operating-systems/Lab/Data/quiz/valgrind-leaks">Quiz</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="memory-actions-and-leaks-in-existing-programs">Memory Actions (and Leaks) in Existing Programs<a class="hash-link" href="#memory-actions-and-leaks-in-existing-programs" title="Direct link to heading">​</a></h2><p>We can use Valgrind to investigate existing programs in the system.
This tells us whether they possess memory leaks:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../lab/support/memory-leak$ valgrind ls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24669== Memcheck, a memory error detector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24669== Copyright (C) 2002-2017, and GNU GPL&#x27;d, by Julian Seward et al.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24669== Using Valgrind-3.13.0 and LibVEX; rerun with -h for copyright info</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24669== Command: ls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24669==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Makefile  memory_leak  memory_leak.cpp  memory_leak_malloc  memory_leak_malloc.c  memory_leak_malloc.o  memory_leak.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24669==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24669== HEAP SUMMARY:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24669==     in use at exit: 21,696 bytes in 14 blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24669==   total heap usage: 51 allocs, 37 frees, 61,331 bytes allocated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24669==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24669== LEAK SUMMARY:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24669==    definitely lost: 0 bytes in 0 blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24669==    indirectly lost: 0 bytes in 0 blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24669==      possibly lost: 0 bytes in 0 blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24669==    still reachable: 21,696 bytes in 14 blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24669==         suppressed: 0 bytes in 0 blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24669== Rerun with --leak-check=full to see details of leaked memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24669==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24669== For counts of detected and suppressed errors, rerun with: -v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24669== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../lab/support/memory-leak$ valgrind ps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24671== Memcheck, a memory error detector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24671== Copyright (C) 2002-2017, and GNU GPL&#x27;d, by Julian Seward et al.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24671== Using Valgrind-3.13.0 and LibVEX; rerun with -h for copyright info</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24671== Command: ps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24671==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PID TTY          TIME CMD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">24671 pts/22   00:00:00 memcheck-amd64-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">26732 pts/22   00:00:01 bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24671==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24671== HEAP SUMMARY:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24671==     in use at exit: 264,929 bytes in 25 blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24671==   total heap usage: 692 allocs, 667 frees, 334,268 bytes allocated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24671==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24671== LEAK SUMMARY:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24671==    definitely lost: 0 bytes in 0 blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24671==    indirectly lost: 0 bytes in 0 blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24671==      possibly lost: 0 bytes in 0 blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24671==    still reachable: 264,929 bytes in 25 blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24671==         suppressed: 0 bytes in 0 blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24671== Rerun with --leak-check=full to see details of leaked memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24671==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24671== For counts of detected and suppressed errors, rerun with: -v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24671== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../lab/support/memory-leak$ valgrind bash -c &#x27;echo &quot;ha&quot;&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24675== Memcheck, a memory error detector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24675== Copyright (C) 2002-2017, and GNU GPL&#x27;d, by Julian Seward et al.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24675== Using Valgrind-3.13.0 and LibVEX; rerun with -h for copyright info</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24675== Command: bash -c echo\ &quot;ha&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24675==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ha</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24675==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24675== HEAP SUMMARY:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24675==     in use at exit: 43,056 bytes in 672 blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24675==   total heap usage: 774 allocs, 102 frees, 51,405 bytes allocated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24675==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24675== LEAK SUMMARY:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24675==    definitely lost: 12 bytes in 1 blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24675==    indirectly lost: 0 bytes in 0 blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24675==      possibly lost: 0 bytes in 0 blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24675==    still reachable: 43,044 bytes in 671 blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24675==         suppressed: 0 bytes in 0 blocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24675== Rerun with --leak-check=full to see details of leaked memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24675==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24675== For counts of detected and suppressed errors, rerun with: -v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==24675== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can see that <code>ls</code> and <code>ps</code> don&#x27;t have memory leaks.
However, the shell (Bash) shows a memory leak of 12 bytes (on the test system).
This may be a false positive or the subject of an actual investigation.</p><p>Note that the <code>still reachable</code> section of the output refers to memory that wasn&#x27;t freed, but still has pointers referring to it.
A true memory leak occurs when no pointers refer any memory area.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="practice-1">Practice<a class="hash-link" href="#practice-1" title="Direct link to heading">​</a></h3><ol><li><p>Investigate 2-3 other executables in the system using Valgrind.</p></li><li><p>Use <code>ltrace</code> to list <code>malloc()</code> and <code>free()</code> calls made by the investigated system executables.</p></li></ol><p>Note that, as explained in the <a href="https://open-education-hub.github.io/operating-systems/Lab/Software%20Stack/libcall-syscall" target="_blank" rel="noopener noreferrer">Software Stack lab</a>, on some systems, <code>ltrace</code> does not accurately show the output, due to <em>now binding</em>.
Fear not, you can always check the library calls with a more verbose and harder to parse <code>ltrace</code> command:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~$ ltrace -x &quot;*&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><a href="/operating-systems/Lab/Data/quiz/memory-leaks">Quiz</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="jemalloc">jemalloc<a class="hash-link" href="#jemalloc" title="Direct link to heading">​</a></h2><p><a href="http://jemalloc.net/" target="_blank" rel="noopener noreferrer">jemalloc</a> is a featureful allocator that is intended to replace the standard allocator in the standard C library (libc).
jemalloc provides replacements for the general <code>malloc()</code> and <code>free()</code> functions, and also provides a custom API targeted for performance tuning.</p><p>As <a href="https://github.com/jemalloc/jemalloc/wiki/Getting-Started" target="_blank" rel="noopener noreferrer">documented</a>, there are multiple ways to use <code>jemalloc</code>, the easiest of which is to use the <code>LD_PRELOAD</code> environment variable and preload the library and hook into <code>malloc()</code> and <code>free()</code> function calls.</p><p>First install <code>jemalloc</code> on our system.
On your typical Ubuntu / Debian-based system, use <code>apt</code>:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../data/lab/content$ sudo apt -y install libjemalloc-dev</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note that this installs the distribution package, not the latest one (that may provide more features).</p><p>With this in place, we can use <code>jemalloc</code> against our pre-built executables or system executables (such as <code>ls</code>, <code>ps</code>).
We can test it against the executable files from <code>support/memory-leak/</code>:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../lab/support/memory-leak$ LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libjemalloc.so ./memory_leak_malloc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Andrei Popescu is 22 years old and likes Linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Ioana David is 23 years old and likes macOS</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>jemalloc</code> can use the <code>MALLOC_CONF</code> environment variable for a <a href="https://www.freebsd.org/cgi/man.cgi?query=malloc.conf" target="_blank" rel="noopener noreferrer">diverse set of configurations</a>.
For example, by using <code>stats_print:true</code> we print out information regarding the use of the library functions:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../lab/support/memory-leak$ LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libjemalloc.so MALLOC_CONF=&quot;stats_print:true&quot; ./memory_leak_malloc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Andrei Popescu is 22 years old and likes Linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Ioana David is 23 years old and likes macOS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">___ Begin jemalloc statistics ___</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Version: 3.6.0-11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Assertions disabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Run-time option settings:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  opt.abort: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  opt.lg_chunk: 22</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  opt.dss: &quot;secondary&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  opt.narenas: 32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  opt.lg_dirty_mult: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  opt.stats_print: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  opt.junk: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  opt.quarantine: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  opt.redzone: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dirty pages: 26:0 active:dirty, 0 sweeps, 0 madvises, 0 purged</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            allocated      nmalloc      ndalloc    nrequests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">small:          72672          114            0            3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">large:          32768            1            0            1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total:         105440          115            0            4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">active:        106496</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mapped:       4194304</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>jemalloc</code> doesn&#x27;t work against system executables using preloading, likely because of security options disabling the use of the library:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../lab/support/memory-leak$ LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libjemalloc.so MALLOC_CONF=&quot;stats_print:true&quot; /bin/ls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Makefile  memory_leak  memory_leak.cpp  memory_leak_malloc  memory_leak_malloc.c  memory_leak_malloc.o  memory_leak.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../lab/support/memory-leak$ LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libjemalloc.so MALLOC_CONF=&quot;stats_print:true&quot; /bin/ps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PID TTY          TIME CMD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 1581 pts/22   00:00:00 ps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">26732 pts/22   00:00:01 bash</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="malloc-in-musl">malloc in Musl<a class="hash-link" href="#malloc-in-musl" title="Direct link to heading">​</a></h2><p>Each libc (or memory allocator such as <code>jemalloc</code>) uses their own implementation of <code>malloc()</code>, <code>free()</code> and other functions.
<a href="https://musl.libc.org/" target="_blank" rel="noopener noreferrer">Musl libc</a> is a lightweight standard C library that provides compatible features with the more heavyweights <a href="https://www.gnu.org/software/libc/" target="_blank" rel="noopener noreferrer">GNU libc</a>.</p><p>Take a look through implementation of <code>malloc()</code> and <code>free()</code> in <a href="https://elixir.bootlin.com/musl/v1.2.3/source/src/malloc" target="_blank" rel="noopener noreferrer">Musl libc</a>.
See all three implementations for <code>malloc()</code>:</p><ul><li>the one in <code>lite_malloc.c</code></li><li>the one in <code>mallocng/malloc.c</code></li><li>the one in <code>oldmalloc/malloc</code></li></ul><p>See also <a href="https://elixir.bootlin.com/musl/v1.2.3/source/src/malloc/mallocng/free.c#L101" target="_blank" rel="noopener noreferrer">the implementation of <code>free()</code></a>.
And <a href="https://elixir.bootlin.com/musl/v1.2.3/source/src/malloc/calloc.c#L33" target="_blank" rel="noopener noreferrer">the implementation of <code>calloc()</code></a>.</p><p>You needn&#x27;t spend too much time browsing the implementation of these functions, just having a broad understanding of how they work.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="app-investigation-deluge">App Investigation: Deluge<a class="hash-link" href="#app-investigation-deluge" title="Direct link to heading">​</a></h2><p><a href="https://www.deluge-torrent.org/" target="_blank" rel="noopener noreferrer">Deluge</a> is a Bittorrent client written in Python.</p><p>We want to locate places that allocate memory in Deluge (in Python).
This generally means locating instantiation of classes.</p><p>Let&#x27;s clone the <a href="https://github.com/deluge-torrent/deluge" target="_blank" rel="noopener noreferrer">source code</a>:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../data/lab/support$ git clone https://github.com/deluge-torrent/deluge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cloning into &#x27;deluge&#x27;...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../data/lab/support$ cd deluge/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../lab/support/deluge$ ls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AUTHORS       deluge      docs             gen_web_gettext.py  MANIFEST.in       msgfmt.py  pyproject.toml  requirements-dev.txt    requirements.txt  setup.py  version.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CHANGELOG.md  DEPENDS.md  generate_pot.py  LICENSE             minify_web_js.py  packaging  README.md       requirements-tests.txt  setup.cfg         tox.ini</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And enter the <code>deluge/core/</code> subdirectory:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../lab/support/deluge$ cd deluge/core/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../deluge/deluge/core$ ls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">alertmanager.py  core.py          daemon.py        filtermanager.py  pluginmanager.py       rpcserver.py       torrent.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">authmanager.py   daemon_entry.py  eventmanager.py  __init__.py       preferencesmanager.py  torrentmanager.py</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Most files in the subdirectory have a class defined.
We can search for instantiations of that class using <code>grep</code>:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../deluge/deluge/core$ grep -rn &#x27;Torrent(&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">torrentmanager.py:644:        torrent = Torrent(handle, options, state, filename, magne</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../deluge/deluge/core$ grep -rn &#x27;TorrentManager(&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">core.py:139:        self.torrentmanager = TorrentManager()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">torrentmanager.py:135:class TorrentManager(component.Component):</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This gives us an overview of when memory is allocated in Deluge / Python.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="practice-2">Practice<a class="hash-link" href="#practice-2" title="Direct link to heading">​</a></h3><ol><li><p>Investigate the lines shown to contain instantiations of classes.
Explore the source code and understand their placements in the source code.</p></li><li><p>Find out other classes and search for their instantiation in the source code.</p></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="app-investigation-servo">App Investigation: Servo<a class="hash-link" href="#app-investigation-servo" title="Direct link to heading">​</a></h2><p><a href="https://servo.org/" target="_blank" rel="noopener noreferrer">Servo</a> is a browser engine written in Rust that provides reusable components to implement web standards.</p><p>We do not clone the repository, since it&#x27;s very large.</p><p>We find information about allocator used, by accessing the <code>components/allocator/</code> in <a href="https://github.com/servo/servo/tree/master/components/allocator" target="_blank" rel="noopener noreferrer">its source code</a>.
In <code>Cargo.toml</code> we see that it requires <code>jemalloc</code> for non-Windows implementations and the standard Windows API (called <code>heapapi</code>) for Windows:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[lib]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">path = &quot;lib.rs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[target.&#x27;cfg(not(windows))&#x27;.dependencies]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jemalloc-sys = { version = &quot;0.3.2&quot; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[target.&#x27;cfg(windows)&#x27;.dependencies]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">winapi = { version = &quot;0.3&quot;, features = [&quot;heapapi&quot;] }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ust: https://github.com/servo/servo</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In <code>lib.rs</code>, in <a href="https://github.com/servo/servo/blob/master/components/allocator/lib.rs#L70" target="_blank" rel="noopener noreferrer"><code>GlobalAlloc:alloc()</code></a> we see it is using <a href="https://jemalloc.net/jemalloc.3.html" target="_blank" rel="noopener noreferrer">the <code>mallocx</code> custom function from <code>jemalloc()</code></a>.
See <a href="https://github.com/servo/servo/blob/master/components/allocator/lib.rs#L17" target="_blank" rel="noopener noreferrer">the initialization of <code>ffi</code></a>.</p><p>See the use of the allocator in the <a href="https://github.com/servo/servo/blob/master/components/net/Cargo.toml" target="_blank" rel="noopener noreferrer"><code>Cargo.toml</code> file in the <code>net</code> component</a>.
Search for the <em>alloc</em> string.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="practice-3">Practice<a class="hash-link" href="#practice-3" title="Direct link to heading">​</a></h3><ol><li>Look for uses of the allocator in other components of Servo.</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="investigation-alocator-in-the-d-programming-language">Investigation: Alocator in the D Programming Language<a class="hash-link" href="#investigation-alocator-in-the-d-programming-language" title="Direct link to heading">​</a></h2><p><a href="https://github.com/dlang/phobos" target="_blank" rel="noopener noreferrer">Phobos</a> is the standard library that comes with the D programming language compiler.</p><p>Let&#x27;s clone the source code:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../std/experimental/allocator$ git clone https://github.com/dlang/phobos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../data/lab/support$ cd phobos/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../lab/support/phobos$ ls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">azure-pipelines.yml  changelog  CODEOWNERS  CONTRIBUTING.md  dub.sdl  etc  index.dd  LICENSE_1_0.txt  posix.mak  project.ddoc  README.md  std  test  unittest.d  win32.mak  win64.mak</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And enter <code>std/experimental/allocator/</code> to browse information about the allocator:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../lab/support/phobos$ cd std/experimental/allocator/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../std/experimental/allocator$ ls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">building_blocks  common.d  gc_allocator.d  mallocator.d  mmap_allocator.d  package.d  showcase.d  typed.d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We then do a search of the <code>allocate(</code> string to find instances of allocation calls:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../std/experimental/allocator$ grep -r &#x27;allocate(&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We see that there are definitions of the function (as expected) as part of <code>...allocator</code> files: <code>mallocator.d</code>, <code>gc_allocator.d</code>, <code>mmap_allocator.d</code>.
Browse the functions and look for implementations of the <code>allocate()</code> function.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="practice-4">Practice<a class="hash-link" href="#practice-4" title="Direct link to heading">​</a></h3><ol><li>Do a similar search and then source code browsing for the <code>deallocate()</code> function.</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="app-investigation-git">App Investigation: Git<a class="hash-link" href="#app-investigation-git" title="Direct link to heading">​</a></h2><p><a href="https://git-scm.com/" target="_blank" rel="noopener noreferrer">Git</a> is among the most used source code management system, powering development infrastructures such as <a href="https://github.com/" target="_blank" rel="noopener noreferrer">GitHub</a>, <a href="https://about.gitlab.com/" target="_blank" rel="noopener noreferrer">GitLab</a> and <a href="https://bitbucket.org/" target="_blank" rel="noopener noreferrer">Bitbucket</a>.</p><p>Let&#x27;s clone <a href="https://github.com/git/git" target="_blank" rel="noopener noreferrer">the repository</a>.
Note that it is about 200MB large:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../data/lab/support$ git clone https://github.com/git/git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../data/lab/support$ cd git/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We look of uses of <code>malloc()</code>:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../lab/support/git$ grep -r &#x27;malloc(&#x27; .</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We see there are multiple calls to the <code>xmalloc()</code> function, which is likely a wrapper for <code>malloc()</code>.
We search for the definition of <code>xmalloc()</code>:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../lab/support/git$ grep -rn &#x27;xmalloc(&#x27; . | grep -v &#x27;;&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./commit.c:188:                 graft = xmalloc(st_add(sizeof(*graft),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./add-interactive.c:157:        list-&gt;sorted.items = xmalloc(st_mult(sizeof(*list-&gt;sorted.items),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./Documentation/RelNotes/2.24.0.txt:91: * xmalloc() used to have a mechanism to ditch memory and address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./Documentation/RelNotes/2.24.0.txt:210:   xmalloc() wrapper, as the rest of the system, for consistency.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./Documentation/RelNotes/2.34.0.txt:230: * mmap() imitation used to call xmalloc() that dies upon malloc()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./Documentation/RelNotes/2.33.1.txt:44: * mmap() imitation used to call xmalloc() that dies upon malloc()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./diffcore-delta.c:56:  new_spanhash = xmalloc(st_add(sizeof(*orig),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./diffcore-delta.c:135: hash = xmalloc(st_add(sizeof(*hash),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./kwset.c:41:/* adapter for `xmalloc()`, which takes `size_t`, not `long` */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./builtin/fast-import.c:461:    b = xmalloc(sizeof(struct object_entry_pool)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./hashmap.h:311: * your structure was allocated with xmalloc(), you can just free(3) it,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./xdiff/xdiff.h:122:#define xdl_malloc(x) xmalloc(x)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./wrapper.c:45:static void *do_xmalloc(size_t size, int gentle)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./wrapper.c:70:void *xmalloc(size_t size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./contrib/credential/wincred/git-credential-wincred.c:26:static void *xmalloc(size_t size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Binary file ./.git/objects/pack/pack-c587b9f11a82bc4d49848d74132e60ea4dbeb177.pack matches</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./git-compat-util.h:1046:# define xalloca(size)      (xmalloc(size))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./git-compat-util.h:1086:#define ALLOC_ARRAY(x, alloc) (x) = xmalloc(st_mult(sizeof(*(x)), (alloc)))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./read-cache.c:3768:    ieot = xmalloc(sizeof(struct index_entry_offset_table)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Line <code>./wrapper.c:70</code> is the one with the definition of the <code>xmalloc()</code> function.
It makes a call of the <a href="https://github.com/git/git/blob/master/wrapper.c#L45" target="_blank" rel="noopener noreferrer"><code>do_xmalloc()</code> function</a>, that makes extra checks.
Also, if the <code>XMALLOC_POISON</code> macro is defined, all the allocated data is overwritten with a &quot;poison&quot; value (<code>0xA5</code>).
This is useful for early detection of memory-related issues, although, evidently, it adds overhead.</p><p>We can look for parts of the source code with the largest number of uses of <code>xmalloc()</code>:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../lab/support/git$ grep -rc &#x27;xmalloc(&#x27; . | grep -v &#x27;:0&#x27; | sort -n -t &#x27;:&#x27; -k 20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./compat/mingw.c:6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./submodule-config.c:6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./merge-recursive.c:7</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can look into the <a href="https://github.com/git/git/blob/master/merge-recursive.c" target="_blank" rel="noopener noreferrer"><code>merge-recursive.c</code> file</a> for uses of the <code>xmalloc()</code> function.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="practice-5">Practice<a class="hash-link" href="#practice-5" title="Direct link to heading">​</a></h3><ol><li><p>Do the same actions as above for the <code>mmap()</code> and <code>xmmap()</code> function calls.</p><p>Note that these are not memory allocation calls, since a valid <code>fd</code> file argument is passed.
These are file mapping calls, that we will talk more as part of the I/O chapter.</p></li></ol></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/operating-systems/Lab/Data/process-memory"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Process Memory</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/operating-systems/Lab/Data/memory-security"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Memory Security</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#memory-leaks" class="table-of-contents__link toc-highlight">Memory Leaks</a><ul><li><a href="#practice" class="table-of-contents__link toc-highlight">Practice</a></li></ul></li><li><a href="#memory-actions-and-leaks-in-existing-programs" class="table-of-contents__link toc-highlight">Memory Actions (and Leaks) in Existing Programs</a><ul><li><a href="#practice-1" class="table-of-contents__link toc-highlight">Practice</a></li></ul></li><li><a href="#jemalloc" class="table-of-contents__link toc-highlight">jemalloc</a></li><li><a href="#malloc-in-musl" class="table-of-contents__link toc-highlight">malloc in Musl</a></li><li><a href="#app-investigation-deluge" class="table-of-contents__link toc-highlight">App Investigation: Deluge</a><ul><li><a href="#practice-2" class="table-of-contents__link toc-highlight">Practice</a></li></ul></li><li><a href="#app-investigation-servo" class="table-of-contents__link toc-highlight">App Investigation: Servo</a><ul><li><a href="#practice-3" class="table-of-contents__link toc-highlight">Practice</a></li></ul></li><li><a href="#investigation-alocator-in-the-d-programming-language" class="table-of-contents__link toc-highlight">Investigation: Alocator in the D Programming Language</a><ul><li><a href="#practice-4" class="table-of-contents__link toc-highlight">Practice</a></li></ul></li><li><a href="#app-investigation-git" class="table-of-contents__link toc-highlight">App Investigation: Git</a><ul><li><a href="#practice-5" class="table-of-contents__link toc-highlight">Practice</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://curs.upb.ro" target="_blank" rel="noopener noreferrer" class="footer__link-item">Main site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://ocw.cs.pub.ro/courses/so" target="_blank" rel="noopener noreferrer" class="footer__link-item">OCW<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/sisteme.de.operare/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 OS Team</div></div></div></footer></div>
<script src="/operating-systems/assets/js/runtime~main.d7a0bbcc.js"></script>
<script src="/operating-systems/assets/js/main.0eb9fb00.js"></script>
</body>
</html>